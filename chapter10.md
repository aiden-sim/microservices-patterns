# 마이크로서비스 테스트 2부
- 통합, 컴포넌트, 종단 간 테스트를 알아보자


## 10.1 통합 테스트 작성
- 405P MSA 구조는 (REST API, 이벤트 채널 이용) 서비스를 전부 띄어 놓고 API를 호출해 보는 종단 테스트가 확실하지만, 느리고 취약하며 비용이 많이 듬
  - 통합 텟트트를 작성하는 것이 좋다.

- 통합 테스트 전략
  - 1) 각 서비스의 어댑터를 테스트
    - ex) OrderRepository, OrderDomainEventPublisher 직접 테스트 
  - 2) 계약을 활용하는 전략 (컨슈머 계약) 
    - ex) 커슈머/프로바이더 둘 다 테스트해서 서로 바라보는 API가 일치하는지 확인
    - 소비자 쪽 테스트 : 컨슈머의 어댑터에 대한 테스트. 계약을 이용하여 프로바이더를 모킹한 스텁을 구성할 수 있어서 컨슈머만으로 통합 테스트를 작성
    - 프로바이더 쪽 테스트 : 프로바이더의 어댑터에 대한 테스트. 어댑터의 디펜던시를 목으로 잡아 놓고 계약을 이용하여 어댑터 테스트

### 10.1.1 통합 테스트: 영속화
- 영속화 통합 테스트의 절차
  - 설정(setup) : DB 스키마를 생성하고 기지의 상태로 초기화하는 DB를 설정
  - 실행(execute) : DB 작업을 수행
  - 확인(verify) : DB 상태, 그리고 DB에서 조회한 객체를 단언
  - 정리(teardown) : 설정 단계에서 시작한 트랜잭션을 롤백하는 등 DB에 변경한 내용을 언두해야 할 경우 사용 

- DB 프로비저닝을 어떻게 할까?
 - 도커를 활용

- DBUnit 이용

### 10.1.2 통합 테스트: REST 요청/응답형 상호 작용
- 스프링 클라우드 컨트랙트를 이용해서 REST 기반의 상호 작용을 테스트

- 소비자쪽 API 게이트웨이 통합 테스트는 계약을 이용하여 주문 서비스의 동작을 흉내낸 HTTP 스텁 서버를 구성
- 계약의 요청은 API 게이트웨이가 스텁에 어떤 HTTP 요청을 하는지 기술하고, 계약의 응답은 스텁이 API 게이트웨이에 어떤 응답을 돌려주는지 기술

#### REST API 계약 예제
```
org.springframework.cloud.contract.spec.Contract.make {
  request {
    method 'GET'
    url '/orders/1223232'

  }
  response {
    status 200

    headers {
      header('Content-Type': 'application/json;charset=UTF-8')
    }
    body('''{"orderId" : "1223232", "state" : "APPROVAL_PENDING"}''')
}
```
- 계약 요청에는 HTTP 메서드 경로, 헤더(옵션)
- 계약 응답에는 HTTP 상태 코드, 헤더(옵션), 본문(해당 시)

#### 컨슈머 주도 계약 통합 테스트: 주문 서비스
- 스프링 클라우드 컨트랙트로 코드-생성된 테스트 클래스의 추상 기초 클래스 HttpBase는 테스트 설정 단계를 담당
 - 이 클래스는 목 디펜던시가 주입된 컨트롤러를 생성하고, 이 목이 컨트롤러가 기대한 응답을 만들어 내도록 설정

#### 소비자 쪽 통합 테스트: API 게이트웨이의 OrderServiceProxy
- 10-4 예제에서 '@AutoConfigureStubRunnder'는 스프릥 클라우드 컨트랙트가 랜덤 포트에 와이어목 서버를 계약 내용대로 구성/실행하도록 지시하는 애너테이션
- 각 테스트 메서드는 OrderServiceProxy를 호출해서 정확한 값이 반환되는지, 아니면 기대한 예외가 던져지는지 확인

### 10.1.3 통합 테스트: 발행/구독 스타일 상호 작용

#### 소비자 쪽 계약 테스트: 주문 이력 서비스

### 10.1.4 통합 계약 테스트: 비동기 요청/응답 상호 작용

#### 비동기 요청/응답 계약 예제

#### 소비자 쪽 계약 통합 테스트: 비동기 요청/응답 상호 작용

#### 프로바이더 쪽, 컨슈머 주도 계약 테스트: 비동기 요청/응답 상호 작용

## 10.2 컴포넌트 테스트 개발


## 10.3 종단 간 테스트 작성

## 10.4 마치며



